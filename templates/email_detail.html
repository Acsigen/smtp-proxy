{% extends "base.html" %}

{% block title %}Email {{ email.id }} - SMTP Proxy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Email Details</h2>
    <a href="/emails" class="btn btn-outline-secondary">Back to List</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                {% if email.subject %}{{ email.subject }}{% else %}<em class="text-muted">(no subject)</em>{% endif %}
            </h5>
            {% if email.is_new() %}
            <form action="/emails/{{ email.id }}/mark-read" method="POST">
                <button type="submit" class="btn btn-sm btn-outline-primary">Mark as Read</button>
            </form>
            {% else %}
            <span class="badge bg-secondary">Read</span>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <table class="table table-borderless mb-0">
            <tbody>
                <tr>
                    <th style="width: 120px;">ID:</th>
                    <td>{{ email.id }}</td>
                </tr>
                <tr>
                    <th>From:</th>
                    <td>{{ email.sender }}</td>
                </tr>
                <tr>
                    <th>To:</th>
                    <td>{{ email.recipients_display() }}</td>
                </tr>
                <tr>
                    <th>Received:</th>
                    <td>{{ email.received_at.strftime('%Y-%m-%d %H:%M:%S %Z') }}</td>
                </tr>
                <tr>
                    <th>Size:</th>
                    <td>{{ email.size_bytes }} bytes</td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td>
                        {% if email.is_new() %}
                        <span class="badge bg-primary">New</span>
                        {% elif email.is_read() %}
                        <span class="badge bg-secondary">Read</span>
                        {% else %}
                        <span class="badge bg-info">{{ email.status }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% if email.auth_user %}
                <tr>
                    <th>Auth User:</th>
                    <td>{{ email.auth_user }}</td>
                </tr>
                {% endif %}
                {% if email.client_ip %}
                <tr>
                    <th>Client IP:</th>
                    <td>{{ email.client_ip }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Message Body</h5>
    </div>
    <div class="card-body">
        <div class="email-body">{{ email.body }}</div>
    </div>
</div>

<div class="accordion" id="rawMessageAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rawMessageCollapse" aria-expanded="false" aria-controls="rawMessageCollapse">
                Raw Message
            </button>
        </h2>
        <div id="rawMessageCollapse" class="accordion-collapse collapse" data-bs-parent="#rawMessageAccordion">
            <div class="accordion-body">
                <div class="raw-message">{{ email.raw_message.decode('utf-8', errors='replace') }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
